#!/bin/bash
# MCP Pre-Commit Hook - FULL AUTOMATION
# Auto-fix, risk check, auto-test, review

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
MCP_ROOT="$(dirname "$SCRIPT_DIR")"
PROJECT_ROOT="$(dirname "$MCP_ROOT")"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

info() { echo -e "${BLUE}[INFO]${NC} $1"; }
ok() { echo -e "${GREEN}[✓]${NC} $1"; }
warn() { echo -e "${YELLOW}[!]${NC} $1"; }
fail() { echo -e "${RED}[✗]${NC} $1"; }

echo ""
echo "╔══════════════════════════════════════════════════════╗"
echo "║     MCP FULL AUTO PRE-COMMIT                         ║"
echo "╚══════════════════════════════════════════════════════╝"
echo ""

ERRORS=0

# Detect Python
PYTHON_CMD=""
if command -v python3 &> /dev/null; then
    PYTHON_CMD="python3"
elif command -v python &> /dev/null; then
    PYTHON_CMD="python"
fi

cd "$PROJECT_ROOT"

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || echo "")
STAGED_PY=$(echo "$STAGED_FILES" | grep '\.py$' || true)

# =============================================================================
# PHASE 1: AUTO-FIX (whitespace, imports, formatting)
# =============================================================================
info "Phase 1: Auto-Fix"

if [ -n "$PYTHON_CMD" ] && [ -f "$MCP_ROOT/mcp.py" ]; then
    FIX_OUTPUT=$($PYTHON_CMD "$MCP_ROOT/mcp.py" fix --safe --apply --staged 2>&1 || true)
    
    if echo "$FIX_OUTPUT" | grep -q "Applied"; then
        ok "Auto-fixed issues"
        git diff --name-only | xargs -r git add 2>/dev/null || true
        ok "Re-staged fixed files"
    else
        ok "No fixes needed"
    fi
fi

# =============================================================================
# PHASE 2: BUG RISK CHECK (block on HIGH risk)
# =============================================================================
info "Phase 2: Bug Risk Check"

if [ -n "$PYTHON_CMD" ] && [ -f "$MCP_ROOT/mcp.py" ] && [ -n "$STAGED_PY" ]; then
    RISK_OUTPUT=$($PYTHON_CMD "$MCP_ROOT/mcp.py" predict-bugs . 2>&1 || true)
    
    # Check for HIGH risk
    if echo "$RISK_OUTPUT" | grep -qi "risk.*high\|HIGH"; then
        HIGH_COUNT=$(echo "$RISK_OUTPUT" | grep -ci "HIGH" || echo "0")
        if [ "$HIGH_COUNT" -gt 3 ]; then
            fail "HIGH RISK: $HIGH_COUNT critical issues detected"
            echo "$RISK_OUTPUT" | grep -i "HIGH" | head -5
            ERRORS=$((ERRORS + 1))
        else
            warn "Found $HIGH_COUNT high-risk patterns (proceeding with caution)"
        fi
    else
        ok "Risk check passed"
    fi
fi

# =============================================================================
# PHASE 3: AUTO-TEST GENERATION (for new functions)
# =============================================================================
info "Phase 3: Auto-Test Check"

if [ -n "$PYTHON_CMD" ] && [ -f "$MCP_ROOT/mcp.py" ] && [ -n "$STAGED_PY" ]; then
    # Check for new functions without tests
    for file in $STAGED_PY; do
        if [ -f "$file" ] && [[ ! "$file" =~ ^test_ ]] && [[ ! "$file" =~ _test\.py$ ]]; then
            TEST_FILE="test_$(basename $file)"
            if [ ! -f "tests/$TEST_FILE" ] && [ ! -f "$TEST_FILE" ]; then
                warn "No tests for: $file"
                # Generate test suggestion (don't block)
            fi
        fi
    done
    ok "Test check complete"
fi

# =============================================================================
# PHASE 4: PATTERN SECURITY SCAN
# =============================================================================
info "Phase 4: Security Scan"

if [ -n "$PYTHON_CMD" ] && [ -f "$MCP_ROOT/mcp.py" ]; then
    SEC_OUTPUT=$($PYTHON_CMD "$MCP_ROOT/mcp.py" security . 2>&1 || true)
    
    if echo "$SEC_OUTPUT" | grep -qi "CRITICAL"; then
        fail "CRITICAL security issues found!"
        ERRORS=$((ERRORS + 1))
    else
        ok "Security scan passed"
    fi
fi

# =============================================================================
# PHASE 5: CODE REVIEW
# =============================================================================
info "Phase 5: Code Review"

if [ -n "$PYTHON_CMD" ] && [ -f "$MCP_ROOT/mcp.py" ]; then
    REVIEW_OUTPUT=$($PYTHON_CMD "$MCP_ROOT/mcp.py" review . 2>&1 || true)
    
    ERROR_COUNT=$(echo "$REVIEW_OUTPUT" | grep -c "\[ERROR\]" || echo "0")
    
    if [ "$ERROR_COUNT" -gt 5 ]; then
        fail "Code review found $ERROR_COUNT errors"
        ERRORS=$((ERRORS + 1))
    else
        ok "Code review passed"
    fi
fi

# =============================================================================
# PHASE 6: AUTO-REMEMBER (track what's being committed)
# =============================================================================
info "Phase 6: Auto-Remember"

if [ -n "$PYTHON_CMD" ] && [ -f "$MCP_ROOT/mcp.py" ]; then
    # Remember staged files for context
    FILES_LIST=$(echo "$STAGED_FILES" | head -10 | tr '\n' ',' | sed 's/,$//')
    if [ -n "$FILES_LIST" ]; then
        $PYTHON_CMD "$MCP_ROOT/mcp.py" remember "pending_commit" "$FILES_LIST" 2>/dev/null || true
    fi
    ok "Context remembered"
fi

# =============================================================================
# FINAL VERDICT
# =============================================================================
echo ""
if [ "$ERRORS" -gt 0 ]; then
    echo "╔══════════════════════════════════════════════════════╗"
    echo "║     ✗ COMMIT BLOCKED - $ERRORS error(s)                      ║"
    echo "╚══════════════════════════════════════════════════════╝"
    fail "Fix errors before committing."
    echo ""
    echo "To bypass (NOT RECOMMENDED): git commit --no-verify"
    exit 1
else
    echo "╔══════════════════════════════════════════════════════╗"
    echo "║     ✓ COMMIT APPROVED                                ║"
    echo "╚══════════════════════════════════════════════════════╝"
    ok "All checks passed!"
    exit 0
fi
